<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Эффект Метели</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            background: linear-gradient(to bottom, #0c1445 0%, #1a237e 30%, #283593 60%, #3949ab 100%);
            min-height: 100vh;
        }

        .snow-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        #backLayer {
            z-index: 1;
        }

        #middleLayer {
            z-index: 2;
        }

        #frontLayer {
            z-index: 3;
            filter: blur(2px);
        }

        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 20;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            color: white;
            font-family: system-ui, -apple-system, sans-serif;
            font-size: 13px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .controls h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }

        .control-section {
            margin-bottom: 20px;
        }

        .control-section h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            gap: 10px;
        }

        .control-row label {
            flex-shrink: 0;
            min-width: 80px;
        }

        .control-row input[type="range"] {
            flex: 1;
            min-width: 100px;
        }

        .control-row .value {
            min-width: 50px;
            text-align: right;
            font-family: monospace;
            color: #8cf;
        }
    </style>
</head>

<body>
    <!-- Три отдельных canvas для слоёв -->
    <canvas id="backLayer" class="snow-layer"></canvas>
    <canvas id="middleLayer" class="snow-layer"></canvas>
    <canvas id="frontLayer" class="snow-layer"></canvas>

    <div class="controls">
        <h3>⚙️ Настройки метели</h3>

        <div class="control-section">
            <h4>Общие</h4>
            <div class="control-row">
                <label>windSpeed</label>
                <input type="range" id="windSpeed" min="0" max="20" step="0.1" value="5">
                <span class="value" id="windSpeedVal">5</span>
            </div>
            <div class="control-row">
                <label>fallSpeed</label>
                <input type="range" id="fallSpeed" min="0.1" max="20" step="0.1" value="5">
                <span class="value" id="fallSpeedVal">5</span>
            </div>
        </div>

        <div class="control-section">
            <h4>Back Layer</h4>
            <div class="control-row">
                <label>count</label>
                <input type="range" id="back-count" min="0" max="5000" step="100" value="2000">
                <span class="value" id="back-countVal">2000</span>
            </div>
            <div class="control-row">
                <label>sizeMin</label>
                <input type="range" id="back-sizeMin" min="0.5" max="5" step="0.1" value="1">
                <span class="value" id="back-sizeMinVal">1</span>
            </div>
            <div class="control-row">
                <label>sizeMax</label>
                <input type="range" id="back-sizeMax" min="0.5" max="5" step="0.1" value="2">
                <span class="value" id="back-sizeMaxVal">2</span>
            </div>
            <div class="control-row">
                <label>speed</label>
                <input type="range" id="back-speed" min="0.1" max="2" step="0.1" value="0.3">
                <span class="value" id="back-speedVal">0.3</span>
            </div>
            <div class="control-row">
                <label>opacity</label>
                <input type="range" id="back-opacity" min="0" max="1" step="0.05" value="0.4">
                <span class="value" id="back-opacityVal">0.4</span>
            </div>
        </div>

        <div class="control-section">
            <h4>Middle Layer</h4>
            <div class="control-row">
                <label>count</label>
                <input type="range" id="middle-count" min="0" max="3000" step="100" value="1000">
                <span class="value" id="middle-countVal">1000</span>
            </div>
            <div class="control-row">
                <label>sizeMin</label>
                <input type="range" id="middle-sizeMin" min="0.5" max="5" step="0.1" value="2">
                <span class="value" id="middle-sizeMinVal">2</span>
            </div>
            <div class="control-row">
                <label>sizeMax</label>
                <input type="range" id="middle-sizeMax" min="0.5" max="8" step="0.1" value="3.5">
                <span class="value" id="middle-sizeMaxVal">3.5</span>
            </div>
            <div class="control-row">
                <label>speed</label>
                <input type="range" id="middle-speed" min="0.1" max="2" step="0.1" value="0.7">
                <span class="value" id="middle-speedVal">0.7</span>
            </div>
            <div class="control-row">
                <label>opacity</label>
                <input type="range" id="middle-opacity" min="0" max="1" step="0.05" value="0.2">
                <span class="value" id="middle-opacityVal">0.2</span>
            </div>
        </div>

        <div class="control-section">
            <h4>Front Layer</h4>
            <div class="control-row">
                <label>count</label>
                <input type="range" id="front-count" min="0" max="500" step="10" value="200">
                <span class="value" id="front-countVal">200</span>
            </div>
            <div class="control-row">
                <label>sizeMin</label>
                <input type="range" id="front-sizeMin" min="1" max="10" step="0.5" value="4">
                <span class="value" id="front-sizeMinVal">4</span>
            </div>
            <div class="control-row">
                <label>sizeMax</label>
                <input type="range" id="front-sizeMax" min="1" max="15" step="0.5" value="6">
                <span class="value" id="front-sizeMaxVal">6</span>
            </div>
            <div class="control-row">
                <label>speed</label>
                <input type="range" id="front-speed" min="0.1" max="3" step="0.1" value="1.2">
                <span class="value" id="front-speedVal">1.2</span>
            </div>
            <div class="control-row">
                <label>opacity</label>
                <input type="range" id="front-opacity" min="0" max="1" step="0.05" value="0.5">
                <span class="value" id="front-opacityVal">0.5</span>
            </div>
        </div>
    </div>

    <script>
        // Три canvas для слоёв
        const canvases = {
            back: document.getElementById('backLayer'),
            middle: document.getElementById('middleLayer'),
            front: document.getElementById('frontLayer')
        };

        const contexts = {
            back: canvases.back.getContext('2d'),
            middle: canvases.middle.getContext('2d'),
            front: canvases.front.getContext('2d')
        };

        let width, height;

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            for (let key in canvases) {
                canvases[key].width = width;
                canvases[key].height = height;
            }
        }
        resize();

        // Настройки слоёв
        const layerConfig = {
            back: { count: 2000, sizeMin: 1, sizeMax: 2, speed: 0.3, opacity: 0.4 },
            middle: { count: 1000, sizeMin: 2, sizeMax: 3.5, speed: 0.7, opacity: 0.2 },
            front: { count: 200, sizeMin: 4, sizeMax: 6, speed: 1.2, opacity: 0.5 }
        };

        // Базовые настройки
        let windSpeed = 5;
        let fallSpeed = 5;

        // Хранилище снежинок — используем TypedArrays для скорости
        const snowData = {
            back: null,
            middle: null,
            front: null
        };

        // Структура данных снежинки: x, y, size, speedX, speedY, wobble, wobbleSpeed
        const FIELDS = 7;

        function createLayer(layer) {
            const config = layerConfig[layer];
            const count = config.count;
            const data = new Float32Array(count * FIELDS);

            for (let i = 0; i < count; i++) {
                const idx = i * FIELDS;
                data[idx + 0] = Math.random() * (width + 100) - 50; // x
                data[idx + 1] = Math.random() * height; // y
                data[idx + 2] = config.sizeMin + Math.random() * (config.sizeMax - config.sizeMin); // size
                data[idx + 3] = (windSpeed + Math.random() * 0.5) * config.speed; // speedX
                data[idx + 4] = (fallSpeed + Math.random() * 0.5) * config.speed; // speedY
                data[idx + 5] = Math.random() * Math.PI * 2; // wobble
                data[idx + 6] = 0.02 + Math.random() * 0.02; // wobbleSpeed
            }

            snowData[layer] = data;
        }

        function resetSnowflake(data, idx, config) {
            // При сильном ветре часть снежинок появляется слева
            const spawnFromLeft = windSpeed > 0 && Math.random() < windSpeed / (windSpeed + fallSpeed);

            if (spawnFromLeft) {
                // Появляемся слева за экраном
                data[idx + 0] = -10 - Math.random() * 50;
                data[idx + 1] = Math.random() * height;
            } else {
                // Появляемся сверху (с учётом ветра — смещаемся влево)
                const windOffset = (windSpeed / fallSpeed) * height;
                data[idx + 0] = Math.random() * (width + windOffset) - windOffset;
                data[idx + 1] = -10 - Math.random() * 50;
            }

            data[idx + 2] = config.sizeMin + Math.random() * (config.sizeMax - config.sizeMin);
            data[idx + 3] = (windSpeed + Math.random() * 0.5) * config.speed;
            data[idx + 4] = (fallSpeed + Math.random() * 0.5) * config.speed;
        }

        function updateAndDrawLayer(layer) {
            const ctx = contexts[layer];
            const config = layerConfig[layer];
            const data = snowData[layer];
            const count = config.count;

            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = `rgba(255, 255, 255, ${config.opacity})`;
            ctx.beginPath();

            for (let i = 0; i < count; i++) {
                const idx = i * FIELDS;

                // Обновление позиции
                data[idx + 5] += data[idx + 6]; // wobble
                data[idx + 0] += data[idx + 3] + Math.sin(data[idx + 5]) * 0.5; // x
                data[idx + 1] += data[idx + 4]; // y

                // Проверка границ
                if (data[idx + 1] > height + 10 || data[idx + 0] > width + 50 || data[idx + 0] < -50) {
                    resetSnowflake(data, idx, config);
                }

                // Рисуем круг (добавляем к общему path)
                const x = data[idx + 0];
                const y = data[idx + 1];
                const size = data[idx + 2];

                ctx.moveTo(x + size, y);
                ctx.arc(x, y, size, 0, Math.PI * 2);
            }

            ctx.fill();
        }

        function animate() {
            updateAndDrawLayer('back');
            updateAndDrawLayer('middle');
            updateAndDrawLayer('front');
            requestAnimationFrame(animate);
        }

        // Обработчики контролов
        function setupControls() {
            // Общие настройки
            document.getElementById('windSpeed').addEventListener('input', (e) => {
                windSpeed = parseFloat(e.target.value);
                document.getElementById('windSpeedVal').textContent = windSpeed;
            });

            document.getElementById('fallSpeed').addEventListener('input', (e) => {
                fallSpeed = parseFloat(e.target.value);
                document.getElementById('fallSpeedVal').textContent = fallSpeed;
            });

            // Настройки слоёв
            const layers = ['back', 'middle', 'front'];
            const props = ['count', 'sizeMin', 'sizeMax', 'speed', 'opacity'];

            layers.forEach(layer => {
                props.forEach(prop => {
                    const input = document.getElementById(`${layer}-${prop}`);
                    if (input) {
                        input.addEventListener('input', (e) => {
                            const value = parseFloat(e.target.value);
                            layerConfig[layer][prop] = value;
                            document.getElementById(`${layer}-${prop}Val`).textContent = value;

                            // Пересоздаём слой только при изменении count
                            if (prop === 'count') {
                                createLayer(layer);
                            }
                        });
                    }
                });
            });
        }

        // Throttled resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                resize();
                createLayer('back');
                createLayer('middle');
                createLayer('front');
            }, 100);
        });

        // Запуск
        setupControls();
        createLayer('back');
        createLayer('middle');
        createLayer('front');
        animate();
    </script>
</body>

</html>